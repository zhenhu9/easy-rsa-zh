Easy-RSA 3 文档自述文件
===============================

本文档介绍了 Easy-RSA 3 及其各个功能的工作方式。

如果您正在寻找背景或细节较少的快速入门，则此（doc/）目录中可能包含特定于实现的 Howto 或自述文件。

Easy-RSA 概述
-----------------

Easy-RSA 是用于管理 X.509 PKI 或公用密钥基础设施的实用程序。 PKI 基于信任特定机构对远程对等方进行身份验证的概念。 有关 PKI 工作原理的更多背景信息，请参阅 `Intro-To-PKI` 文档。

该代码是用与平台无关的 POSIX shell 编写的，允许在各种主机系统上使用。 Windows 官方发行版还捆绑了使用 Easy-RSA 所需的程序。 shell 程序代码设法限制它所依赖的外部程序的数量。 与加密有关的任务将 openssl 用作功能后端。

功能亮点
------------------

以下是 Easy-RSA 更值得注意的功能的非详尽列表：

 *  Easy-RSA 能够管理多个 PKI，每个 PKI 都有各自独立的配置，存储目录和 X.509 扩展处理。
 *  支持多种主题名称（X.509 DN 字段）格式选项。 对于 VPN，这意味着可以使用更清洁的 commonName 设置。
 *  所有支持的平台都使用一个后端，以确保没有任何平台被丰富功能所“遗漏”。 均支持类 Unix（BSD，Linux 等）和 Windows。
 *  Easy-RSA 的 X.509 支持包括 CRL，CDP，keyUsage/eKu 属性和其它功能。 包含的支持可以作为高级功能进行更改或扩展。
 *  交互式和自动化（批量）操作模式。
 *  灵活的配置：可以通过命令行选项，环境变量，配置文件或它们的组合来启用功能。
 *  内置默认值就可以使用 Easy-RSA，而无需先编辑配置文件。

获取和使用 Easy-RSA
----------------------------

#### 下载并解压缩（安装）

  Easy-RSA 的主程序是一个脚本，并受几个配置文件支持。 这样，就不需要正式的“安装”。 准备使用 Easy-RSA 就像下载压缩包一样简单（Linux/Unix 的 .tar.gz；Windows 的 .zip），然后将其解压缩到您选择的位置。 无需编译或基于操作系统的设置。

  您应该以非超级用户（非管理员）帐户安装和运行 Easy-RSA，因为不需要超级用户访问权限。

#### 运行 Easy-RSA

  调用 Easy-RSA 是通过您首选的 shell 完成的。 在 Windows 下，您将使用 `EasyRSA Start.bat` 程序提供适合使用 Easy-RSA 的 POSIX-shell 环境。
  
  运行命令的基本格式为：

    ./easyrsa command [ cmd-opts ]

  其中，`command` 是要运行的命令的名称，而 `cmd-opts` 是要提供给该命令的任何选项。 一些命令具有强制或可选的 cmd-opts。 请注意该命令的前导`./`  部分：在类 Unix 的环境中这是必需的，并且对于某些 Windows 用户而言可能是一个新概念。

  常规用法和命令帮助可以用以下格式显示：

    ./easyrsa help [ command ]

  当不使用任何命令运行时，将显示常规用法和可用命令列表。 提供命令时，将显示该命令的详细帮助输出。

配置 Easy-RSA
--------------------

与早期版本不同，Easy-RSA 3 在操作之前不再需要任何配置文件。 但是，`vars.example`文件包含许多注释选项，可用于根据需要控制非默认行为。 读取此文件将提供可用的基本配置的想法。 请注意，必须将 vars 文件仅命名为 `vars`（不带扩展名）才能有效使用它。

此外，可以在运行时使用命令行上的选项定义一些选项。 完整列表可用一下格式显示：

    ./easyrsa help options

这些选项中的任何一个都可以根据需要置于command 之前，如下所示：

    ./easyrsa [options] command [ cmd-opts ]

对于专家来说，可以通过 env-vars 和自定义 X.509 扩展来获得额外的配置灵活性。 有关详细信息，请查阅 `EasyRSA-Advanced` 文档。

入门：基础知识
---------------------------

对于熟悉 PKI 工作原理的人来说，此处使用的某些术语是通用的。 如果您需要有关 PKI 工作原理的更基本描述，请参考文档 `Intro-To-PKI` 描述的 PKI 基础知识。

#### 创建 Easy-RSA PKI

  为了做一些有用的事情，Easy-RSA 需要首先为 PKI 初始化一个目录。 一次安装 Easy-RSA 即可管理多个 PKI，但除非另有说明，否则默认目录简称为 “pki”。

  要创建或清除（重新初始化）新的 PKI，请使用以下命令：

    ./easyrsa init-pki

  这将创建一个可供使用的新的空白 PKI 结构。 创建之后，该 PKI 可用于创建新的 CA 或生成密钥对。

#### PKI 目录结构

  Easy-RSA PKI 包含以下目录结构：

  * private/ - 该主机上生成的带有私钥的目录。
  * reqs/ - 本地生成的证书请求（对于 CA 导入的请求存储在此处）的目录。

  在干净的 PKI 中，只有裸目录，不存在文件。 稍后调用的命令将根据操作创建必要的文件。

  建立 CA 时，Easy-RSA 和（间接）openssl 的组合会创建许多新文件。 重要的 CA 文件是：

  * `ca.crt` - 这是 CA 证书。
  * `index.txt` - 这是所有已发行证书的“主数据库”。
  * `serial` - 存储下一个序列号（序列号递增）。
  * `private/ca.key` - 这是 CA 私钥（对安全性至关重要）。
  * `certs_by_serial/` - 所有带有 CA 签名证书的目录（按序列号）。
  * `issued/` - 使用 commonName 颁发证书的目录。

#### 创建 PKI 之后

  一旦创建了 PKI，下一个有用的步骤将是创建 CA，或为它们所需的系统生成密钥对。 继续下面的相关部分。

用 Easy-RSA 作为 CA
----------------------

#### 构建 CA

  为了签名请求以生成证书，您需要一个 CA。 要在已创建的 PKI 中创建新的 CA，请运行：

    ./easyrsa build-ca

  确保使用强密码短语来保护 CA 私钥。 请注意，将来用 CA 执行签名操作时必须提供此密码短语，因此请务必记住它。

  在创建过程中，您还将为 CA 选择一个名称，即“通用名称（CN）”。该名称仅用于显示目的，可以根据需要设置。

#### 将请求导入到 CA

  一旦建立了 CA，便可以使用 PKI 从外部系统导入请求，导入该外部系统正在向此 CA 请求签名证书。 为了签名请求，必须先将其导入，以便 Easy-RSA 知道。 该请求文件必须是 PKCS#10 格式的标准 CSR。

  无论要导入的文件名如何，Easy-RSA 都会使用在导入期间定义的“短名称”来引用此请求。 导入工作如下：

    ./easyrsa import-req /path/to/request.req nameOfRequest

  nameOfRequest 通常应指提出请求的系统或人员。

#### 签名请求

  Easy-RSA 导入请求后，即可对其进行审核和签名。 每个证书都需要一个“类型”，该类型可以控制 Easy-RSA 附带的三种扩展类型：`client`，`server` 和 `ca`，具体描述如下：

  * client - TLS 客户端，适用于 VPN 用户或 Web 浏览器（Web 客户端）。
  * server - TLS 服务器，适用于 VPN 或 Web 服务器。
  * ca - 从属 CA，将多个 CA 链接在一起时使用。

  本地站点可以根据需要定义其它类型的证书； 有关详细信息，请参见高级文档。

#### 废除证书和发布 CRL

  如果需要废除已签发的证书，可以按以下步骤进行：

    ./easyrsa revoke nameOfRequest

  要生成适合发布到使用它的系统的 CRL，请运行：

    ./easyrsa gen-crl

  请注意，由于证书在其他方面仍然有效，因此需要将其发布或发送到依赖最新 CRL 的系统。

使用 Easy-RSA 生成密钥对和请求
----------------------------------------------

Easy-RSA 可以生成密钥对和 PKCS#10 格式的证书请求。 CA 需要此请求才能生成并返回已签名的证书。

理想情况下，永远不要在用于 CA 的 PKI 中为客户端或服务器生成实体密钥对。 最好分开此过程，并仅在计划使用它们的系统上生成密钥对。

Easy-RSA 可以使用以下命令生成密钥对和请求：

    ./easyrsa gen-req nameOfRequest

然后，您将有机会修改请求的主题详细信息。 默认情况下，Easy-RSA 使用命令行中提供的简称，尽管您可以根据需要随意更改它。 提供密码和主题详细信息后，将显示密钥对和请求文件。

为了获得签名证书，必须将请求文件发送到 CA 进行签名； 如果将单个 PKI 用作 CA 和密钥对/请求生成两者，则显然不需要此步骤，因为已“导入”了生成的请求。

